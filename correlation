# -*- coding: utf-8 -*-
"""
Created on Wed Dec 23 12:44:33 2015

@author: Negmo
"""
from skimage import io
from skimage import img_as_ubyte
import os
import matplotlib.pyplot as plt
from skimage.feature import greycomatrix, greycoprops
from sklearn import svm
from sklearn import tree

#load an image from a given directory
def load(imdir,f):
    io.use_plugin('pil')
    image=io.imread(os.path.join(imdir, f),True)
    return img_as_ubyte(image)
    
train_size=10
   
#collect all the stones in an array
stones=[]
for typ in 'abcd':
    for i in range(0,train_size):
        stones.append(load(r"C:\Users\Negmo\.spyder2-py3\dataset\%s" % typ,'%d.jpg' % i))
        
#extract texture features using glcm
ys=[]#array of correlation
for i in range(len(stones)):
    glcm = greycomatrix(stones[i], [5], [0], 256, symmetric=True, normed=True)
    ys.append(greycoprops(glcm, 'correlation')[0, 0])
    
#classification    
clar=[]
cltype=[]
for i in range(len(ys)):
        clar.append([ys[i]])
        cltype.append("abcd"[i//train_size])

svm_clf=svm.SVC()
svm_clf.fit(clar,cltype)

tree_clf=tree.DecisionTreeClassifier()
tree_clf.fit(clar,cltype)

#testing predictions
svm_incorrect=[]
svm_correct=[]

tree_incorrect=[]
tree_correct=[]
for typ in 'abcd':
    for i in range(train_size,37):
        p_img=load(r"C:\Users\Negmo\.spyder2-py3\dataset\%s" % typ,'%d.jpg' % i)
        p_glcm=greycomatrix(p_img, [5], [0], 256, symmetric=True, normed=True)
        p=[greycoprops(p_glcm, 'correlation')[0, 0]]
        svm_prediction=svm_clf.predict([p])
        tree_prediction=tree_clf.predict([p])
        if typ!=svm_prediction:
            svm_incorrect.append((typ,svm_prediction[0],i))
        else:
            svm_correct.append((typ,i))
            
        if typ!=tree_prediction:
            tree_incorrect.append((typ,tree_prediction[0],i))
        else:
            tree_correct.append((typ,i))
            
svm_percision=(((37-train_size)*4-len(svm_incorrect))/((37-train_size)*4))*100
tree_percision=(((37-train_size)*4-len(tree_incorrect))/((37-train_size)*4))*100
# for each type, plot correlation
fig = plt.figure(figsize=(20, 20))            
ax = fig.add_subplot(3, 1, 2)

for i in range(4):
    ax.plot(ys[train_size*i:train_size*(i+1)], [10**i]*train_size,'bo')

ax.set_xlabel('GLCM features')
ax.set_ylabel('stone types')
ax.legend()
fig.suptitle('Grey level co-occurrence matrix correlation \n presicion :\n disicion tree:%f \n svm:%f' %(tree_percision,svm_percision), fontsize=14)
plt.show()
